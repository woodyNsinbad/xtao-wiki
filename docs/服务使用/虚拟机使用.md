# 虚拟机使用说明

## 1. 主界面说明

![虚拟机主界面.png](/pic/server_usage/虚拟机主界面.png)

+ **虚拟机列表**: 虚拟机的主界面显示了当前用户的虚拟机列表（管理员可以看到全部用户的虚拟机）。虚拟机列表显示了每台虚拟机的基本信息，包括状态、资源配置、所在节点等，并且提供了每台虚拟机可以进行的操作列表按钮。
+ **虚拟机状态与颜色**: 虚拟机列表中每台虚拟机的名称会通过不同的颜色区分虚拟机的状态。灰色：虚拟机处于关机状态；绿色：虚拟机处于开机状态；红色：虚拟机处于异常状态。
+ **当前状态查看**：将光标悬停到虚拟机的名称处会显示虚拟机的当前状态信息。尤其当虚拟机处于异常状态时，可以看到详细的异常描述信息。
+ **查看虚拟机配置**：点击虚拟机的名称可以看到该虚拟机的详细配置。用户可以看到为虚拟机分配的IP、VNC密码、端口映射等信息。

## 2. 创建虚拟机
用户点击创建虚拟机按钮会弹出虚拟机配置的填写框，用户通过填写合适的配置创建虚拟机。

### 2.1 参数说明
- **名称**：必填。指定要创建的虚拟机名称，全局唯一。
- **处理器**：必填。指定处理器的数量。此处的数值并非指处理器的物理核数，而是指虚拟机支持的最大线程数。
- **内存**：必填。指定虚拟机的内存大小，单位：GB。
- **镜像**：选填。用于安装虚拟机操作系统的镜像文件。系统提供了几种常用的操作系统镜像给用户使用，如果用户有自己的系统镜像可以联系技术人员导入到系统中使用。
- **项目**：选填。
- **调度域**：选填。指定虚拟机的调度范围。
> 注意：集群中目前并非所有节点支持启动虚拟机，所以需要指定调度域来限制虚拟机的调度范围。目前有三个调度域控制虚拟机的调度。其中**vm_host**支持主机模式的虚拟机调度，**vm_bridge**支持桥接模式的虚拟机调度，**vm_external**用于调度需要访问外网的虚拟机（只支持桥接模式）。如果用户没有权限使用该调度域，需要联系系统管理员授权。
{.is-warning}
- **VNC密码**：选填。通过VNC远程桌面连接虚拟机时需要输入的密码。不指定时可以直接连入，无需提供密码。
- **主机模式（是/否）**：必填（默认否）。是（主机模式）：虚拟机会分配外部的IP（10.10.4.0/24和172.168.78.0/24网段），用户可以直接通过IP访问虚拟机；否（桥接模式）：虚拟机会分配一个内部IP，该IP无法直接在外部访问，需要设置端口映射，然后通过宿主机IP+外部端口方式访问。
> 建议：因为外部IP是有限的，所以应谨慎使用主机模式。如果虚拟机主要用于开发、日常使用等，需要在虚拟机内访问外网，而不需要从外部主动访问虚拟机内部，此时可以使用桥接模式；如果虚拟机用于启动一些服务，如数据库、WWW服务等，需要从外部主动访问虚拟机内部的这些服务，此时可以优先考虑使用桥接模式+端口映射的方式，最后再考虑直接使用主机模式。
{.is-info}

- **端口映射**：选填，支持多选。当虚拟机使用桥接模式时，如果需要从外部主动访问虚拟机，就需要指定端口映射。例如，用户想通过SSH连接到虚拟机，SSH的默认端口是22，此时就需要指定一对端口映射。虚拟机端口填22，主机端口可以不填，此时会自动分配一个未使用的端口，用户也可以填写一个自己想用的端口，但要注意避免端口冲突。假设主机端口是1022，虚拟机所在的宿主机IP是10.10.4.101。此时用户就可以通过ssh 10.10.4.103 -p 1022登入虚拟机。使用主机模式时不需要指定端口映射。
- **硬盘**：选填，支持多选。大小：指定硬盘的大小，单位GB；总线：支持虚拟机内部硬盘的总线类型，支持IDE/SATA/SCSI等，默认为SATA。
> 注意：虚拟机使用集群共享存储作为硬盘资源池，共享存储的空间宝贵且有限，请根据虚拟机的实际使用情况指定合适的大小。
{.is-warning}
- **外部硬盘**：选填，支持多选。该参数使用场景较少。如果用户在其他环境中有一台虚拟机，想将其迁移到Achelous平台中，就可以将原虚拟机的系统盘和数据盘的镜像文件指定为外部硬盘。

## 3. 启动虚拟机（开机）
用户创建的虚拟机初始时处于关机状态，需要通过点击开机按钮启动虚拟机。此时系统会对虚拟机进行调度，选择合适的节点启动虚拟机。同样的，如果用户关闭了虚拟机，想要再次开机时就需要点击开机按钮启动。

## 4. 虚拟机网络配置
无论是主机模式还是桥接模式，系统都会为虚拟机分配IP（可以在**查看虚拟机配置**查看IP），并将IP注册到DHCP服务上。虚拟机启动后如果网卡配置了从DHCP启动会自动获取IP，如果没有则需要用户手动启动网卡（可联系技术人员协助配置）。虚拟机访问外网需要配置默认路由，通常网卡在获取到IP之后会自动设置默认路由，如果没有需要用户手动设置。桥接模式的默认路由为**192.168.200.1**，主机模式的默认路由为**10.10.4.254**。可以联系技术人员协助设置。

## 5. 虚拟机操作列表
### 5.1 修改端口映射
功能同创建虚拟机时的端口映射参数。支持用户动态的修改端口映射配置。
### 5.2 开机
启动虚拟机
### 5.3 关机
关闭虚拟机。
> 注意：关机功能相当于物理机直接掉电的效果，可能会造成数据损坏，所以尽量避免使用该功能，最好通过登入虚拟机内部执行关机指令。
{.is-warning}

> 注意：为节约系统资源，虚拟机关机一段时间后（5分钟）系统会回收虚拟机所占用的资源。如果用户再次启动虚拟机，系统会重新对虚拟机进行调度，此时虚拟机的运行节点可能会和之前节点不同，但IP不会变。
{.is-warning}

### 5.4 链接桌面
通过VNC链接虚拟机远程桌面。如果用户设置了VNC密码此时需要输入VNC密码，可以在**查看虚拟机配置**查看VNC密码。
### 5.5 重启
重启虚拟机
### 5.6 重试
重试功能主要用于虚拟机出现异常时，例如虚拟机所在物理节点异常。重试会将现有的虚拟机强制停掉，然后重新进行调度。
### 5.7 复制
复制功能允许用户基于一个已有的虚拟机复制新的虚拟机。用户可以在复制时修改虚拟机的配置（硬盘配置不允许修改）。
> 注意：复制功能不会复制虚拟机的外部硬盘，新的虚拟机会和原有虚拟机共享外部硬盘。所以为避免访问冲突，拥有外部硬盘的虚拟机要谨慎使用复制功能。
{.is-warning}

### 5.8 销毁
完全删除一台虚拟机，包括配置信息和硬盘数据。
### 5.9 添加硬盘
向虚拟机添加硬盘。
> 注意：如果虚拟机处于开机状态，添加硬盘操作会使虚拟机重启，请确保无误，建议先关机再操作。
{.is-warning}

### 5.10 修改资源
修改虚拟机的资源配置，包括CPU、内存、调度域等。
> 注意：修改虚拟机可能导致当前的虚拟机强制关机并重新调度，请确保无误，建议先关机再操作。
{.is-warning}

### 5.11 共享
将虚拟机共享出去给其他用户使用。其中需要注意的参数如下：

- **虚拟机账号**：选填。指定虚拟机的管理员账号。一般用于windows虚拟机的非公开共享方式（即必须预约使用）。指定账号后，虚拟机的登陆密码会在不同用户的使用期间变换，以确保在某一用户使用期间其他用户无法登陆操作。

> 注意：系统设置虚拟机的登陆密码需要对应的虚拟机内安装相关插件，如果需要该功能可以联系技术人员协助安装插件。
{.is-warning}

- **是否公开**：必填。是：共享出去以后所有其他用户都可以随意使用；否：共享出去以后其他用户必须先预约使用时间，只有在预约时间内才可以使用。
- **最长租约**：**是否公开**为**否**时必填。指定一个用户可以预约的最长期限。单位：小时。
### 5.12 取消共享
收回共享出去的虚拟机
### 5.13 预约
预约其他用户共享出来的虚拟机，指定要使用的时间段。只有在预约时间段内才可以使用该虚拟机。

## 6. 导入镜像

用户可将镜像上传至存储系统指定路径