# 通过Poros分析任务性能瓶颈或资源使用情况
每个用户可以登录Poros界面，查看自己任务的运行情况。用户常常遇见下面几种情况：

- 我的任务好像运行的很慢，时间比期望的长，是什么原因呢？
- 我的任务究竟用了多少CPU和内存，或者GPU？我应该分配多少资源呢？
- 我的任务异常被kill了，是什么原因呢？是使用内存太多吗？
- 我的任务读写了多少数据呢？

这些问题都可以通过任务画像获得答案。

## 1. 如何找到任务

下面几种方式提交对应的查找方式如下：

### 1.1 通过qsub提交

可以通过qstat获取任务的id，通过qstat -i id查看任务，得到任务的长ID。

![qstat获取任务长id.png](/pic/resource-usage/qstat获取任务长id.png)

例如上图中的paladin-task.5732e021-ccf9-4fd1-9f82-8a241397a42c即为任务的长ID。获取长ID后可以在Poros界面的个人中心的任务概览界面的运行或者结束任务列表中找到任务。

![长id查看结束任务列表.png](/pic/resource-usage/长id查看结束任务列表.png)


### 1.2 用户通过biolci运行的WDL任务

可以通过`biocli job status <jobid>`获取每个阶段的任务的ID


### 1.3 通过Poros启动的个人jupyter或者R服务

可以在Poros界面的个人中心看到。

![用户任务列表运行中.png](/pic/resource-usage/用户任务列表运行中.png)

点击上图中的任务名称下的链接即可跳转到任务画像界面

## 2. 通过任务画像分析任务

### 2.1 分析任务性能瓶颈

选中任务进入了任务画像界面，用户通过最上面的资源延迟曲线图发现性能瓶颈。

![任务资源延迟.png](/pic/resource-usage/任务资源延迟.png)

资源延迟图上的每一个点代表一个周期，约为3分钟。纵轴是比率，表示任务所有线程等待资源（CPU、SwapIn、IO或者Flush）的时间占该周期的比率。例如如果任务有4个线程，其中2个用于读取数据，第一个线程该周期内读取数据总共阻塞在IO上花了0.4倍的周期时长，第二个线程阻塞花了0.8倍的周期时长，则该周期内整个IO资源延迟的比率就是1.2，这也就是IO资源延迟曲线在该时刻的纵轴的值。
所以一般来讲，曲线越低，越说明该类操作不是任务的性能瓶颈。图上有4类资源延迟：

+ CPU：表示任务等待CPU的时间比率，高说明任务分配CPU过少
+ SwapIn：表示任务从swap加载数据到内存花的时间比率，高说明内存分配不足，应该增加内存
+ IO：表示任务读写数据操作等待的时间比率，高说明任务有IO性能瓶颈
+ Flush：表示任务回收内存时刷数据等待的时间比率，高说明内存不够或者有IO瓶颈


### 2.2 分析任务资源使用状况
+ 分析任务的资源利用率
任务画像的资源利用率页面可以查看任务的CPU、内存、GPU和显存的实际使用率。

![任务cpu利用率.png](/pic/resource-usage/任务cpu利用率.png)

![任务内存利用率.png](/pic/resource-usage/任务内存利用率.png)

通过分析该CPU和内存利用率曲线，用户可以发现：
- 任务运行是否正常：如果任务3线程计算，分配3个CPU，CPU占用率在300%左右，说明任务一直满负荷运行，占用着CPU。如果时间过长，应检查参数是否正确或者程序是否存在死循环。
- 任务内存利用率：内存利用率曲线可以说明任务分配的内存是否在使用，如果利用率过低，说明内存分配过多。

+ 分析任务的资源使用/分配对比曲线
任务画像底部的任务资源分配和使用比率曲线，可以更直观的反映资源分配是否合适。

![任务分配使用图.png](/pic/resource-usage/任务分配使用图.png)

需要注意的是：
- 默认允许超额使用CPU，因此CPU的使用可能超过分配。
- 内存曲线图有内存分配、内存使用和Swap使用三个量。如果Swap使用一直增长，也说明应增加内存分配值。

平台对内存使用了严格管控，如果内存使用超过申请量一定次数和数量，任务将会因OOM（Out of Memory）杀掉。内存超限曲线刻画了任务超限次数的变化。

![任务内存超限.png](/pic/resource-usage/任务内存超限.png)

### 2.3 分析任务读写数据量
用户可通过任务读写数据量曲线分析任务实际读入或者写出的数据量大小及变化曲线。

![任务读写数据量.png](/pic/resource-usage/任务读写数据量.png)
